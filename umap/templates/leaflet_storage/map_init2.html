{% load leaflet_storage_tags %}
        
<div id="progress"><div id="progress-bar"></div></div>
<div id="map" style="width: 100%;position: absolute;top: 0; /* bottom: 0; */left: 0;right: 0;bottom: 120px;">

<div id="featureForms" style="display:none; position: relative; /*margin-top: 200px; margin-left: 20px;*/  z-index: 20; /*width: 150px; */">
        <div  >
            <div id="featureTree" style="overflow-x: hidden; ">
                <ul class="nav nav-list">
                    <li><label class="tree-toggler nav-header">Area</label>
                        <ul class="nav nav-list tree">
                            
                            <table style="width:182px">
                                <tr>
                                    <td style="    width: 80px;"></td>
                                    <td colspan="2" style="text-align: center;"><span style="    float: left;">Area</span>
                                        <button onclick="lockFeatureSelection()"  id="lockFeatureButton" title="Always use labels of the area feature" type="submit"                                                class="btn btn-default lowerButton">
                                            <i id="lockIcon" class="fa fa-lock"></i>
                                        </button><span style="    float: right;">Label</span>
                                    </td>
                                </tr>
                                <tr id="rulerTR">
                                    <td>Ruler</td>
                                    <td><input id="A-Country" data-style="sharp"  data-onstyle="info" type="checkbox" data-size="mini" data-toggle="toggle" checked data-on=" " data-off=" "></td>
                                    <td><input id="T-Country"  data-style="sharp" data-onstyle="info" type="checkbox" data-size="mini" data-toggle="toggle" checked data-on=" " data-off=" "></td>
                                </tr>
                                <tr id="cultureTR">
                                    <td>Culture</td>
                                    <td><input id="A-Culture" data-style="sharp" data-onstyle="info" type="checkbox" data-size="mini" data-toggle="toggle" data-on=" " data-off=" "></td>
                                    <td><input id="T-Culture" data-style="sharp" data-onstyle="info" type="checkbox" data-size="mini" data-toggle="toggle" data-on=" " data-off=" "></td>
                                </tr>
                                <tr id="religionTR">
                                    <td>Religion</td>
                                    <td><input id="A-Religion" data-style="sharp" data-onstyle="info" type="checkbox" data-size="mini" data-toggle="toggle" data-on=" " data-off=" "></td>
                                    <td><input id="T-Religion" data-style="sharp" data-onstyle="info" type="checkbox" data-size="mini" data-toggle="toggle" data-on=" " data-off=" "></td>
                                </tr>
                                <tr id="mainreligionTR">
                                    <td>Main Religion</td>
                                    <td><input id="A-MainRel" data-style="sharp" data-onstyle="info" type="checkbox" data-size="mini" data-toggle="toggle" data-on=" " data-off=" "></td>
                                    <td><input id="T-MainRel" data-style="sharp" data-onstyle="info" type="checkbox" data-size="mini" data-toggle="toggle" data-on=" " data-off=" "></td>
                                </tr>
                                <tr id="populationTR">
                                    <td>Population</td>
                                    <td><input id="A-Population" data-style="sharp" data-onstyle="info" type="checkbox" data-size="mini" data-toggle="toggle" data-on=" " data-off=" "></td>
                                    <td><!--<input id="T-Population" data-style="sharp" data-onstyle="info" type="checkbox" disabled data-size="mini" data-toggle="toggle" data-on=" " data-off=" "> --></td>
                                </tr>
                            </table>
                            
                        </ul>
                    </li>
                    <li class="divider"></li>
                    <li><label class="tree-toggler nav-header">Marker</label>
                        <ul class="nav nav-list tree">
                            <li><input id="cityChecked" data-onstyle="default" type="checkbox" data-size="small" data-toggle="toggle" data-on="Cities" data-off="Cities"> <label class="tree-toggler nav-header advanced">>></label>
                                <ul class="nav nav-list tree">
                                    <li>

                                        <div class="squaredOne">
                                            <input type="checkbox" checked value="None" id="citiesBox" name="check" />
                                            <label for="citiesBox"></label>
                                        </div>
                                        <div class="labelForBox">
                                            Cities
                                        </div>
                                    </li>
                                    <li>

                                        <div class="squaredOne">
                                            <input type="checkbox" checked value="None" id="castlesBox" name="check" />
                                            <label for="castlesBox"></label>
                                        </div>
                                        <div class="labelForBox">
                                            Castles
                                        </div>
                                    </li>
                                    <li style="display: none">

                                        <div class="squaredOne">
                                            <input type="checkbox" value="None" id="buildingsBox" name="check" />
                                            <label for="buildingsBox"></label>
                                        </div>
                                        <div class="labelForBox">
                                            Buildings
                                        </div>
                                    </li>
                                </ul>
                            </li>
                            <li> <input id="peopleChecked" data-onstyle="default" type="checkbox" data-size="small" data-toggle="toggle" data-on="People" data-off="People"> <label class="tree-toggler nav-header advanced">>></label>
                                <ul class="nav nav-list tree">
                                    
                                    <li>
                                    
                                    <div class="squaredOne">
                                        <input type="checkbox" checked value="None" id="milBox" name="check" />
                                        <label for="milBox"></label>
                                    </div>
                                        <div class="labelForBox">
                                            Military
                                        </div>                         
                                    </li>
                                    <li>
                                        <div class="squaredOne">
                                            <input type="checkbox" checked value="None" id="expBox" name="check" />
                                            <label for="expBox"></label>
                                        </div>
                                        <div class="labelForBox">
                                            Explorer
                                        </div>
                                    </li>
                                    <li>
                                        <div class="squaredOne">
                                            <input type="checkbox" checked value="None" id="polBox" name="check" />
                                            <label for="polBox"></label>
                                        </div>
                                        <div class="labelForBox">
                                            Politician
                                        </div>
                                    </li>
                                    <li>
                                        <div class="squaredOne">
                                            <input type="checkbox" checked value="None" id="sciBox" name="check" />
                                            <label for="sciBox"></label>
                                        </div>
                                        <div class="labelForBox">
                                            Scientist
                                        </div>
                                    </li>
                                    <li>
                                        <div class="squaredOne">
                                            <input type="checkbox" checked value="None" id="artBox" name="check" />
                                            <label for="artBox"></label>
                                        </div>
                                        <div class="labelForBox">
                                            Artist
                                        </div>
                                    </li>
                                    <li>
                                        <div class="squaredOne">
                                            <input type="checkbox" checked value="None" id="relBox" name="check" />
                                            <label for="relBox"></label>
                                        </div>
                                        <div class="labelForBox">
                                            Religious
                                        </div>
                                    </li>
                                    <li>
                                        <div class="squaredOne">
                                            <input type="checkbox" checked value="None" id="athBox" name="check" />
                                            <label for="athBox"></label>
                                        </div>
                                        <div class="labelForBox">
                                            Athlete
                                        </div>
                                    </li>
                                    <li>
                                        <div class="squaredOne">
                                            <input type="checkbox" value="None" id="uncBox" name="check" />
                                            <label for="uncBox"></label>
                                        </div>
                                        <div class="labelForBox">
                                            Other
                                        </div>
                                    </li>
                                </ul>
                            </li>
                            <li><input id="eventsChecked" data-onstyle="default" type="checkbox" data-size="small" data-toggle="toggle" data-on="Battles" data-off="Battles">
                            </li>
                            <li><input id="artChecked"  data-onstyle="default"  type="checkbox" data-size="small" data-toggle="toggle" data-on="Artefacts" data-off="Artefacts" >
                            </li>
                            <li><input id="otherChecked"  data-onstyle="default"  type="checkbox" data-size="small" data-toggle="toggle" data-on="Other" data-off="Other" > <label class="tree-toggler nav-header advanced">>></label>
                                <ul class="nav nav-list tree">
                                    <li>

                                        <div class="squaredOne">
                                            <input type="checkbox" checked value="None" id="areaInfoBox" name="check" />
                                            <label for="areaInfoBox"></label>
                                        </div>
                                        <div class="labelForBox">
                                            Area Information
                                        </div>
                                    </li>
                                    <li>

                                        <div class="squaredOne">
                                            <input type="checkbox" value="None" id="unclassifiedBox" name="check" />
                                            <label for="unclassifiedBox"></label>
                                        </div>
                                        <div class="labelForBox">
                                            Unclassified
                                        </div>
                                    </li>
                                </ul>
                            </li>
                            <li id="listPlaceholder">
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
        

    </div>
<div id="hierarchyForms" style="display:none; position: relative; /*margin-top: 200px; margin-left: 20px;*/  z-index: 20; /*width: 150px; */">
    <div>
        <div id="hierarchyTree" style="overflow-x: hidden; ">
            <ul class="nav nav-list">
                <li> <label id="polHier" class="tree-toggler nav-header hier">Ruler</label> <label id="culHier" class="tree-toggler nav-header hier">Culture</label> <label id="relHier" class="tree-toggler nav-header hier">Religion</label> <label id="mrelHier" class="tree-toggler nav-header hier">Main Religion</label>
                    <label id="allProvinces" class="tree-toggler nav-header hier">All Provinces</label>

                    <label id="btn_visualize" class="tree-toggler nav-header hier">Visualize</label>
                </li>
                <br>
                <div id="hierTables">
                <table id="aggregatedDatatable" class="display" cellspacing="0" width="100%">
                    <thead>
                    <tr>
                        <th id="metricName">Metric</th>
                        <th>Total Area</th>
                        <th>Total Population</th>
                        <th>GoTo</th>
                    </tr>
                    </thead>
                </table>
                <table id="fullDatatable" class="display" cellspacing="0" width="100%">
                    <thead>
                    <tr>
                        <th>Province</th>
                        <th>Ruler</th>
                        <th>Culture</th>
                        <th>Religion</th>
                        <th>Main Religion</th>
                        <th>Capital</th>
                        <th>Area</th>
                        <th>Population</th>
                        <th>GoTo</th>
                    </tr>
                    </thead>
                </table>
                </div>
                
                <div id="hierVis" style="display: none">
                    <div id="main-sunburst">
                        <div id="sequence"></div>
                        <div id="sunBurstchart">
                            <div id="explanation" style="visibility: hidden;">
                                <span id="percentage"></span><br/>
                                of people living in <span id="yearSB"></span> are estimated to belong to the selected group
                            </div>
                        </div>
                    </div>
                    <div id="sidebar2" style=" background-color: transparent; /* pointer-events: none; */  "> 
                        <a title="Toggle grouping: Religion <-> Ruler" onclick="toggleSBData();" style=" float: left; " class="btn faButton">
                        <i class="fa fa-exchange"></i></a>
                        &nbsp;
                        <a title="Legend" id="togglelegend" style=" float: right; " class="btn faButton">
                            <i class="fa fa-list-ol"></i></a>
                        <br></div>
                    <div id="sidebar" style=" background-color: transparent;pointer-events: none;  ">
                        
                        <div id="legend" style="visibility: hidden; pointer-events: none;line-height: 15px;margin-top: 35px;">Circle layers<br>(inner to outer):<br><br></div>
                    </div>
                </div>
                
            </ul>
        </div>
    </div>

</div>

</div>
        

</div>
<div id="timeline" style="height: 120px; position: absolute; left: 0; right: 0; bottom: 0;"></div>

<script src="{{ STATIC_URL }}staticReqs/sequences.js"></script>
<script type="text/javascript">
    
    console.log("*** initializing map");

    var b_area = true;
    
    var b_people = false;
    var b_city = false;
    var b_events = false;
    var b_art = false;
    var b_other = false;

    var b_sub_areaInfo = true;
    var b_sub_cities = true;
    var b_sub_castles = true;
    var b_sub_buildings = true;
    
    var b_sub_military = true;
    var b_sub_politician = true;
    var b_sub_scientist = true;
    var b_sub_religious = true;
    var b_sub_athlete = true;
    var b_sub_uncP = false;  // !!
    var b_sub_exp = true;
    var b_sub_artist = true;
    //var b_sub_battle = false;
    //var b_sub_siege = false;
    //var b_sub_artefact = true;
    var b_sub_unclassified = false;
    var a_hierLoaded = false;
    
    $("#citiesBox").change(function(){
        console.debug("start go")
        b_sub_cities = document.getElementById("citiesBox").checked;
        if(b_city && b_sub_cities){
            map.getDataLayerByStorageId(newYear).fetchData();
            ClusterSuperGroup.addLayers(a_settlementsData)
        }
        else{
            if ($.inArray(newYear, a_settlementsLoaded) != -1){
                ClusterSuperGroup.removeLayers(a_settlementsData);
            }
        }
        console.debug("end go")
    });
            
    $("#castlesBox").change(function(){
        b_sub_castles = document.getElementById("castlesBox").checked;
        if(b_city && b_sub_castles){
            map.getDataLayerByStorageId(newYear).fetchData();
            ClusterSuperGroup.addLayers(a_castlesData)
        }
        else{
            if ($.inArray(newYear, a_castlesLoaded) != -1){
                ClusterSuperGroup.removeLayers(a_castlesData)
            }
        }
    });
    
    $("#unclassifiedBox").change(function(){
        b_sub_unclassified = document.getElementById("unclassifiedBox").checked;
        if(b_other && b_sub_unclassified){
            map.getDataLayerByStorageId(newYear).fetchData();
            ClusterSuperGroup.addLayers(a_unclassifiedData)
        }
        else{
            if ($.inArray(newYear, a_unclassifiedLoaded) != -1){
                ClusterSuperGroup.removeLayers(a_unclassifiedData)
            }
        }
    });

    $("#areaInfoBox").change(function(){
        b_sub_areaInfo = document.getElementById("areaInfoBox").checked;
        if(b_other && b_sub_areaInfo){
            map.getDataLayerByStorageId(newYear).fetchData();
            ClusterSuperGroup.addLayers(a_areaInfoData)
        }
        else{
            if ($.inArray(newYear, a_areaInfoLoaded) != -1){
                ClusterSuperGroup.removeLayers(a_areaInfoData)
            }
        }
    });
    
    $("#milBox").change(function(){
        b_sub_military = document.getElementById("milBox").checked;
        if(b_people && b_sub_military){
            map.getDataLayerByStorageId(newYear).fetchData();
            ClusterSuperGroup.addLayers(a_milData)
        }
        else{
            if ($.inArray(newYear, a_milLoaded) != -1){
                ClusterSuperGroup.removeLayers(a_milData)
            }
        }
    });

    $("#polBox").change(function(){
        b_sub_politician = document.getElementById("polBox").checked;
        if(b_people && b_sub_politician){
            map.getDataLayerByStorageId(newYear).fetchData();
            ClusterSuperGroup.addLayers(a_polData)
        }
        else{
            if ($.inArray(newYear, a_polLoaded) != -1){
                ClusterSuperGroup.removeLayers(a_polData)
            }
        }
    });

    $("#sciBox").change(function(){
        b_sub_scientist = document.getElementById("sciBox").checked;
        if(b_people && b_sub_scientist){
            map.getDataLayerByStorageId(newYear).fetchData();
            ClusterSuperGroup.addLayers(a_sciData)
        }
        else{
            if ($.inArray(newYear, a_sciLoaded) != -1){
                ClusterSuperGroup.removeLayers(a_sciData)
            }
        }
    });

    $("#relBox").change(function(){
        b_sub_religious = document.getElementById("relBox").checked;
        if(b_people && b_sub_religious){
            map.getDataLayerByStorageId(newYear).fetchData();
            ClusterSuperGroup.addLayers(a_relData)
        }
        else{
            if ($.inArray(newYear, a_relLoaded) != -1){
                ClusterSuperGroup.removeLayers(a_relData)
            }
        }
    });

    $("#uncBox").change(function(){
        b_sub_uncP = document.getElementById("uncBox").checked;
        if(b_people && b_sub_uncP){
            map.getDataLayerByStorageId(newYear).fetchData();
            ClusterSuperGroup.addLayers(a_uncPData)
        }
        else{
            if ($.inArray(newYear, a_uncPLoaded) != -1){
                ClusterSuperGroup.removeLayers(a_uncPData)
            }
        }
    });

    $("#expBox").change(function(){
        b_sub_exp = document.getElementById("expBox").checked;
        if(b_people && b_sub_exp){
            map.getDataLayerByStorageId(newYear).fetchData();
            ClusterSuperGroup.addLayers(a_expData)
        }
        else{
            if ($.inArray(newYear, a_expLoaded) != -1){
                ClusterSuperGroup.removeLayers(a_expData)
            }
        }
    });

    $("#artBox").change(function(){
        b_sub_artist = document.getElementById("artBox").checked;
        if(b_people && b_sub_artist){
            map.getDataLayerByStorageId(newYear).fetchData();
            ClusterSuperGroup.addLayers(a_artistData)
        }
        else{
            if ($.inArray(newYear, a_artistLoaded) != -1){
                ClusterSuperGroup.removeLayers(a_artistData)
            }
        }
    });

    $("#athBox").change(function(){
        b_sub_athlete = document.getElementById("athBox").checked;
        if(b_people && b_sub_athlete){
            map.getDataLayerByStorageId(newYear).fetchData();
            ClusterSuperGroup.addLayers(a_athData)
        }
        else{
            if ($.inArray(newYear, a_athLoaded) != -1){
                ClusterSuperGroup.removeLayers(a_athData)
            }
        }
    });
    
    
    $("#areaChecked").change(function(){
        b_area = document.getElementById("areaChecked").checked;

        
        if(b_area){
            map.getDataLayerByStorageId(newYear).fetchData();
            $('svg').show();
        }
        else{
         //   if ($.inArray(newYear, a_area != -1){
                $('svg').hide()
         //   }
        }
    });

    $("#peopleChecked").change(function(){
        b_people = document.getElementById("peopleChecked").checked;
        console.debug("map.datalayers:",map.datalayers);
        
        if(b_people){
            map.getDataLayerByStorageId(newYear).fetchData()
        }
            
        else{
            if ($.inArray(newYear, a_peopleLoaded) != -1){
               ClusterSuperGroup.removeLayers(a_peopleLoaded)
            }
            
            if ($.inArray(newYear, a_milLoaded) != -1){
                ClusterSuperGroup.removeLayers(a_milData)
            }
            if ($.inArray(newYear, a_polLoaded) != -1){
                ClusterSuperGroup.removeLayers(a_polData)
            }
            if ($.inArray(newYear, a_sciLoaded) != -1){
                ClusterSuperGroup.removeLayers(a_sciData)
            }
            if ($.inArray(newYear, a_relLoaded) != -1){
                ClusterSuperGroup.removeLayers(a_relData)
            }
            if ($.inArray(newYear, a_uncPLoaded) != -1){
                ClusterSuperGroup.removeLayers(a_uncPData)
            }
            if ($.inArray(newYear, a_expLoaded) != -1){
                ClusterSuperGroup.removeLayers(a_expData)
            }
            if ($.inArray(newYear, a_artistLoaded) != -1){
                ClusterSuperGroup.removeLayers(a_artistData)
            }
            if ($.inArray(newYear, a_athLoaded) != -1){
                ClusterSuperGroup.removeLayers(a_artistData)
            }
        }
        
    });
    
    $("#cityChecked").change(function(){
        b_city = document.getElementById("cityChecked").checked;
        console.debug("map.datalayers:",map.datalayers)
        // search for storage id of iterate map.datalayers_index    year in object and do:
        
        if(b_city){
            if (b_sub_castles) ClusterSuperGroup.addLayers(a_castlesData)
            else{
                ClusterSuperGroup.removeLayers(a_castlesData)
            }
            if (b_sub_cities) ClusterSuperGroup.addLayers(a_settlementsData)
            else{
                ClusterSuperGroup.removeLayers(a_settlementsData)
            }
            map.getDataLayerByStorageId(newYear).fetchData()
        }
        else{      
            if ($.inArray(newYear, a_castlesLoaded) != -1){
                ClusterSuperGroup.removeLayers(a_castlesData)
            }
            if ($.inArray(newYear, a_settlementsLoaded) != -1){
                ClusterSuperGroup.removeLayers(a_settlementsData)
            }
        }
        
    });

    $("#artChecked").change(function(){
        b_art = document.getElementById("artChecked").checked;
        if(b_art){
            ClusterSuperGroup.addLayers(a_artefactData)
            map.getDataLayerByStorageId(newYear).fetchData()
        }

        else{
            if ($.inArray(newYear, a_artefactLoaded) != -1){
                ClusterSuperGroup.removeLayers(a_artefactData)
            }
        }
    });
    
    $("#eventsChecked").change(function(){
        b_events = document.getElementById("eventsChecked").checked;
        if(b_events){
            ClusterSuperGroup.addLayers(a_eventsData)
            map.getDataLayerByStorageId(newYear).fetchData()
        }
            
        else{
            if ($.inArray(newYear, a_eventsLoaded) != -1){
                ClusterSuperGroup.removeLayers(a_eventsData)
            }
        }
    });

    $("#otherChecked").change(function(){
        b_other = document.getElementById("otherChecked").checked;
        console.debug("map.datalayers:",map.datalayers)
        // search for storage id of iterate map.datalayers_index    year in object and do:

        if(b_other){
            if(b_sub_unclassified) {
                ClusterSuperGroup.removeLayers(a_unclassifiedData)
            }
            else{
                ClusterSuperGroup.addLayers(a_unclassifiedData)
            }
            if(b_sub_areaInfo) {
                ClusterSuperGroup.addLayers(a_areaInfoData)
            }
            else{
                ClusterSuperGroup.removeLayers(a_areaInfoData)
            }
            map.getDataLayerByStorageId(newYear).fetchData()
        }
        else{
            if ($.inArray(newYear, a_unclassifiedLoaded) != -1){
                ClusterSuperGroup.removeLayers(a_unclassifiedData)
            }
            if ($.inArray(newYear, a_areaInfoLoaded) != -1){
                ClusterSuperGroup.removeLayers(a_areaInfoData)
            }
        }

    });

    
    var map = new L.Storage.Map("map", {{ map_settings|notag|safe }});
    map.setMaxBounds(L.latLngBounds(L.latLng(-90, -240), L.latLng(90, 240)));
    map.options.maxZoom=9
    map.options.minZoom=2
    
    map.on("viewreset", reset);
    console.debug("before")
    svgProv = d3.select(map.getPanes().overlayPane).append("svg");

    svgProv.style("z-index","3");
    
    map.on("zoomstart", function () {
        svgProv.attr("visibility", "hidden")
    });
    map.on("zoomend", function () {
        svgProv.attr("visibility", "visible ")
    });

    g00 = svgProv.append("g").attr("class", "leaflet-zoom-hide");

    g1 = g00.append("g");
    g0 = g00.append("g");


    gProvinceAreas = g1.append("g").attr("id", "provinceAreas");
    gProvinceLabels = g1.append("g").attr("id", "provinceLabels");

    gActiveCouLabels = g0.append("g").attr("id", "activeCouLabels");
    gActiveCulLabels = g0.append("g").attr("id", "activeCulLabels");
    gActiveRelLabels = g0.append("g").attr("id", "activeRelLabels");
    gActiveRelGenLabels = g0.append("g").attr("id", "activeRelGenLabels");
    transform2 = d3.geo.transform({point: projectPoint});
    path = d3.geo.path().projection(transform2);

    var ttt = [];


    /*
     d3.json("/static/svgOverlay/DL500x.geojson", function (DL500) {

     d3.json("/static/svgOverlay/DL50a.geojson", function (DL50) {

     ttt = DL50;
     activeYear = jQuery.extend({}, DL50);
     dl50 = jQuery.extend({}, DL50);
     dl500 = jQuery.extend({}, DL500);

     provinceCollection = jQuery.extend({}, tprovinceCollection);

     console.debug(provinceCollection);
     setupCollections();
     addTextFeat('country');
     addAreaFeat('country');

     });
     });
     });

     */

    $( "#timeline" ).mouseup(function(event) {

        if (isdragging) return;
        console.debug("!mouseup");
        //      if (staticCore.eventParams.dragging) return;

        var deltaX = event.clientX,
                x = deltaX,

                time = staticCore.body.util.toTime(x);

        staticCore.setCustomTime(time);

        // fire a timechange event
        staticCore.body.emitter.emit('timechange', {
            time: new Date(staticCore.customTime.valueOf())
        });


    });


    $("#featureForms")
            .prependTo(".storage-browse-actions");
    $("#hierarchyForms")
            .prependTo(".storage-browse-actions");
    
    $('#listPlaceholder').append($(".storage-browse-link").detach());

    $(".storage-browse-toggle").click(function(){ 
        if($("#featureForms").css("display") == "none"){
            $(".storage-browse-actions").css("display","block");
            $("#featureForms").css("display","block");
            
            $("#hierarchyForms").css("display","none");
            $(".storage-browse-toggle").addClass( "storage-browse-toggle-active" );
            $(".storage-browse-hierarchy").removeClass( "storage-browse-toggle-active" );
            $(".leaflet-control-browse.storage-control.leaflet-control").css("border","0px solid rgb(187, 187, 187)")
            
        }
        else{
            $("#featureForms").css("display","none");
            $(".storage-browse-toggle").removeClass( "storage-browse-toggle-active" );
            $(".leaflet-control-browse.storage-control.leaflet-control").css("border","1px solid rgb(187, 187, 187)")
            $(".storage-browse-actions").css("display","none");
        }    
    })

    $(".storage-browse-hierarchy").click(function(){
        console.debug($("#hierarchyForms").css("display"))
        if($("#hierarchyForms").css("display") == "none"){
            $(".storage-browse-hierarchyForms").css("display","block");
            $(".storage-browse-actions").css("display","block");
            $("#hierarchyForms").css("display","block");
            $("#featureForms").css("display","none");
            $(".storage-browse-hierarchy").addClass( "storage-browse-toggle-active" );
            $(".storage-browse-toggle").removeClass( "storage-browse-toggle-active" );
            $(".leaflet-control-browse.storage-control.leaflet-control").css("border","0px solid rgb(187, 187, 187)")

        }
        else{
            $("#hierarchyForms").css("display","none");
            $(".storage-browse-hierarchy").removeClass( "storage-browse-toggle-active" );
            $(".leaflet-control-browse.storage-control.leaflet-control").css("border","1px solid rgb(187, 187, 187)")
            $(".storage-browse-actions").css("display","none");
        }

    })
/*
$("input:checkbox").change(function(){
    var group = ":checkbox[name='"+ $(this).attr("name") + "']";
   
    console.debug("group",group,$(this).prop('checked'),$(group).not($(this)))
    
    if($(this).prop('checked')){
        console.debug("now doing it")
        $(group).not($(this)).click();
        $(this).parent().click();
    }


    });
 */
</script>
<script class="cssdeck" src="http://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script class="cssdeck" src="http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.3.1/js/bootstrap.min.js"></script>

<script src="{{ STATIC_URL }}staticReqs/jquery.dataTables.min.js"></script>


<script>
    var aggTable, fulTable;
    $(document).ready(function () {
        
        $(".leaflet-top.leaflet-right").prepend('<div class="leaflet-control" id="geoGallery" style="display:none"></div><div class="storage-control leaflet-control" style=" clear: none; float: none; position: absolute; right: 0px; top: 0px; "><a class="btnOpenGallery" href="#" title="Open Gallery"></a></div>')
        $(".leaflet-top.leaflet-right").css("width","96%")
        $(".leaflet-top.leaflet-right").css("height","130px");

        $(".btnOpenGallery").click(function () {
            if($('#geoGallery').css("display") !== "none"){
                $('#geoGallery').css("display","none")
                $(".leaflet-top.leaflet-right").css("overflow","inherit");
            }
            else {
                $('#geoGallery').css("display","block")
                $(".leaflet-top.leaflet-right").css("overflow","hidden");
                if($('#geoGallery').html() == ""){
                    updateGeoGallery(newYear-10,newYear+10,"people");
                }                
            }
            
        });
        
        aggTable = $('#aggregatedDatatable').dataTable({
            "bLengthChange": false,
            "bFilter": true,
            "bInfo": true,
            "dom": '<"pull-left"f><"pull-right">tip',
            "oLanguage": { "sSearch": "" },
            "order": [[ 2, "desc" ]],
            "bAutoWidth": false
    });
        fulTable = $('#fullDatatable').dataTable({
            "bLengthChange": false,
            "bFilter": true,
            "bInfo": true,
            "dom": '<"pull-left"f><"pull-right"l>tip',
            "oLanguage": { "sSearch": "" },
            "bAutoWidth": false
    });

    
        
        $("#fullDatatable_wrapper").css("display","none");
        $("#aggregatedDatatable_wrapper").css("display","none");
        
        $('.dataTables_filter input').attr("placeholder", "Search");
        
        map.addLayer(ClusterSuperGroup);
        
        $('label.tree-toggler').click(function () {
            $(this).parent().children('ul.tree').toggle(300);
        });

        $('#featureTree .tree-toggler').click()

       // $('#toggle-one').bootstrapToggle();



        $( "#A-Country" ).parent().on( "click", function() {
            hideAndAdd('A-Country','country');
        });
        $( "#T-Country" ).parent().on( "click", function() {
            hideAndAdd('T-Country','country');
        });
        $( "#A-Culture" ).parent().on( "click", function() {
            hideAndAdd('A-Culture','culture')
        });
        $( "#T-Culture" ).parent().on( "click", function() {
            hideAndAdd('T-Culture','culture')
        });
        $( "#A-Religion" ).parent().on( "click", function() {
            hideAndAdd('A-Religion','religion')
        });
        $( "#T-Religion" ).parent().on( "click", function() {
            hideAndAdd('T-Religion','religion')
        });
        $( "#A-MainRel" ).parent().on( "click", function() {
            hideAndAdd('A-MainRel','religionGeneral')
        });
        $( "#T-MainRel" ).parent().on( "click", function() {
            hideAndAdd('T-MainRel','religionGeneral')
        });
        $( "#A-Population" ).parent().on( "click", function() {
            hideAndAdd('A-Population','population')
        });

        $( "#relHier" ).on( "click", function() {
            $("#hierTables").css("display","block");
            $("#hierVis").css("display","none");
            
            $("#fullDatatable_wrapper").css("display","none");
            $("#aggregatedDatatable_wrapper").css("display","table");
            if(!a_hierLoaded){
                a_hierLoaded=true;
                reloadHierarchy()
            }
            aggTable.fnClearTable();
            aggTable.fnAddData( sortRel );
            activeListFeature="rel";
        });
        $( "#mrelHier" ).on( "click", function() {
            $("#hierTables").css("display","block");
            $("#hierVis").css("display","none");
            $("#fullDatatable_wrapper").css("display","none");
            $("#aggregatedDatatable_wrapper").css("display","table");
            if(!a_hierLoaded){
                a_hierLoaded=true;
                reloadHierarchy()
            }
            aggTable.fnClearTable();
            aggTable.fnAddData( sortmRel );
            activeListFeature="mrel";
        });
        $( "#culHier" ).on( "click", function() {
            $("#hierTables").css("display","block");
            $("#hierVis").css("display","none");
            $("#fullDatatable_wrapper").css("display","none");
            $("#aggregatedDatatable_wrapper").css("display","table");
            if(!a_hierLoaded){
                a_hierLoaded=true;
                reloadHierarchy()
            }

            aggTable.fnClearTable();
            aggTable.fnAddData( sortCul );
            activeListFeature="cul";
        });
        $( "#polHier" ).on( "click", function() {
            $("#hierTables").css("display","block");
            $("#hierVis").css("display","none");
            $("#fullDatatable_wrapper").css("display","none");
            $("#aggregatedDatatable_wrapper").css("display","table");
            if(!a_hierLoaded){
                a_hierLoaded=true;
                reloadHierarchy()
            }
            aggTable.fnClearTable();
            aggTable.fnAddData( sortRuler );
            activeListFeature="rul";
        });

        $( "#allProvinces" ).on( "click", function() {
            $("#hierTables").css("display","block");
            $("#hierVis").css("display","none");
            $("#aggregatedDatatable_wrapper").css("display","none");
            $("#fullDatatable_wrapper").css("display","table");
            if(!a_hierLoaded){
                a_hierLoaded=true;
                reloadHierarchy()
            }
            fulTable.fnClearTable();
            fulTable.fnAddData( sortAll );
        });

        

        $( "#btn_visualize" ).on( "click", function() {
            
            $("#hierTables").css("display","none");
            $("#hierVis").css("display","block");
            if(!a_hierLoaded){
                a_hierLoaded=true;
                reloadHierarchy()
                
            }
            switchSBData(currSB);
        });
        
        lockFeatureSelection();
    });
    
    function toggleSBData(){
        if(currSB == "rel"){
            currSB='rul';
            switchSBData("rul");
        }
        else {
            currSB='rel';
            switchSBData("rel");
        }               
    }


</script>